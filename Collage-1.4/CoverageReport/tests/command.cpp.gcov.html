<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - Collage - tests/command.cpp</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">tests</a> - command.cpp<span style="font-size: 80%;"> (source / <a href="command.cpp.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">Collage</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">86</td>
            <td class="headerCovTableEntry">86</td>
            <td class="headerCovTableEntryHi">100.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2016-03-29 17:11:40</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">10</td>
            <td class="headerCovTableEntry">10</td>
            <td class="headerCovTableEntryHi">100.0 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : </a>
<span class="lineNum">       2 </span>            : /* Copyright (c) 2013-2015, Stefan.Eilemann@epfl.ch
<span class="lineNum">       3 </span>            :  *
<span class="lineNum">       4 </span>            :  * This library is free software; you can redistribute it and/or modify it under
<span class="lineNum">       5 </span>            :  * the terms of the GNU Lesser General Public License version 2.1 as published
<span class="lineNum">       6 </span>            :  * by the Free Software Foundation.
<span class="lineNum">       7 </span>            :  *
<span class="lineNum">       8 </span>            :  * This library is distributed in the hope that it will be useful, but WITHOUT
<span class="lineNum">       9 </span>            :  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
<span class="lineNum">      10 </span>            :  * FOR A PARTICULAR PURPOSE.  See the GNU Lesser General Public License for more
<span class="lineNum">      11 </span>            :  * details.
<span class="lineNum">      12 </span>            :  *
<span class="lineNum">      13 </span>            :  * You should have received a copy of the GNU Lesser General Public License
<span class="lineNum">      14 </span>            :  * along with this library; if not, write to the Free Software Foundation, Inc.,
<span class="lineNum">      15 </span>            :  * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
<span class="lineNum">      16 </span>            :  */
<span class="lineNum">      17 </span>            : 
<span class="lineNum">      18 </span>            : #include &lt;co/co.h&gt;
<span class="lineNum">      19 </span>            : #include &lt;test.h&gt;
<span class="lineNum">      20 </span>            : #include &lt;lunchbox/clock.h&gt;
<span class="lineNum">      21 </span>            : 
<span class="lineNum">      22 </span>            : #define NCOMMANDS 10000
<span class="lineNum">      23 </span>            : 
<span class="lineNum">      24 </span>            : enum Commands
<span class="lineNum">      25 </span>            : {
<span class="lineNum">      26 </span>            :     CMD_ASYNC = co::CMD_NODE_CUSTOM,
<span class="lineNum">      27 </span>            :     CMD_SYNC,
<span class="lineNum">      28 </span>            :     CMD_DATA,
<span class="lineNum">      29 </span>            :     CMD_DATA_REPLY
<a name="30"><span class="lineNum">      30 </span>            : };</a>
<span class="lineNum">      31 </span>            : 
<a name="32"><span class="lineNum">      32 </span><span class="lineCov">          1 : static const std::string payload( &quot;Hi! I am your payload. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Ut eget felis sed leo tincidunt dictum eu eu felis. Aenean aliquam augue nec elit tristique tempus. Pellentesque dignissim adipiscing tellus, ut porttitor nisl lacinia vel. Donec malesuada lobortis velit, nec lobortis metus consequat ac. Ut dictum rutrum dui. Pellentesque quis risus at lectus bibendum laoreet. Suspendisse tristique urna quis urna faucibus et auctor risus ultricies. Morbi vitae mi vitae nisi adipiscing ultricies ac in nulla. Nam mattis venenatis nulla, non posuere felis tempus eget. Cras dapibus ultrices arcu vel dapibus. Nam hendrerit lacinia consectetur. Donec ullamcorper nibh nisl, id aliquam nisl. Nunc at tortor a lacus tincidunt gravida vitae nec risus. Suspendisse potenti. Fusce tristique dapibus ipsum, sit amet posuere turpis fermentum nec. Nam nec ante dolor.&quot; );</span></a>
<span class="lineNum">      33 </span>            : 
<span class="lineNum">      34 </span><span class="lineCov">          4 : class LocalNode : public co::LocalNode</span>
<span class="lineNum">      35 </span>            : {
<span class="lineNum">      36 </span>            :     typedef co::CommandFunc&lt; LocalNode &gt; CmdFunc;
<a name="37"><span class="lineNum">      37 </span>            : </a>
<span class="lineNum">      38 </span>            : public:
<span class="lineNum">      39 </span><span class="lineCov">          2 :     LocalNode()</span>
<span class="lineNum">      40 </span>            :         : _gotAsync( false )
<span class="lineNum">      41 </span><span class="lineCov">          2 :         , _counter( 0 )</span>
<span class="lineNum">      42 </span>            :     {
<span class="lineNum">      43 </span><span class="lineCov">          2 :         co::CommandQueue* q = getCommandThreadQueue();</span>
<span class="lineNum">      44 </span><span class="lineCov">          2 :         registerCommand( CMD_ASYNC, CmdFunc( this, &amp;LocalNode::_cmdAsync ), q );</span>
<span class="lineNum">      45 </span><span class="lineCov">          2 :         registerCommand( CMD_SYNC, CmdFunc( this, &amp;LocalNode::_cmdSync ), q );</span>
<span class="lineNum">      46 </span><span class="lineCov">          2 :         registerCommand( CMD_DATA, CmdFunc( this, &amp;LocalNode::_cmdData ), q );</span>
<span class="lineNum">      47 </span>            :         registerCommand( CMD_DATA_REPLY,
<span class="lineNum">      48 </span><span class="lineCov">          2 :                          CmdFunc( this, &amp;LocalNode::_cmdDataReply ), q );</span>
<span class="lineNum">      49 </span><span class="lineCov">          2 :     }</span>
<span class="lineNum">      50 </span>            : 
<span class="lineNum">      51 </span>            : private:
<span class="lineNum">      52 </span>            :     bool _gotAsync;
<a name="53"><span class="lineNum">      53 </span>            :     uint32_t _counter;</a>
<span class="lineNum">      54 </span>            : 
<span class="lineNum">      55 </span><span class="lineCov">      10000 :     bool _cmdAsync( co::ICommand&amp; )</span>
<span class="lineNum">      56 </span>            :     {
<span class="lineNum">      57 </span><span class="lineCov">      10000 :         _gotAsync = true;</span>
<span class="lineNum">      58 </span><span class="lineCov">      10000 :         return true;</span>
<a name="59"><span class="lineNum">      59 </span>            :     }</a>
<span class="lineNum">      60 </span>            : 
<span class="lineNum">      61 </span><span class="lineCov">      20001 :     bool _cmdSync( co::ICommand&amp; command )</span>
<span class="lineNum">      62 </span>            :     {
<span class="lineNum">      63 </span><span class="lineCov">      20001 :         TEST( _gotAsync );</span>
<span class="lineNum">      64 </span><span class="lineCov">      20001 :         ackRequest( command.getNode(), command.get&lt; uint32_t &gt;( ));</span>
<span class="lineNum">      65 </span><span class="lineCov">      20001 :         return true;</span>
<a name="66"><span class="lineNum">      66 </span>            :     }</a>
<span class="lineNum">      67 </span>            : 
<span class="lineNum">      68 </span><span class="lineCov">      10000 :     bool _cmdData( co::ICommand&amp; command )</span>
<span class="lineNum">      69 </span>            :     {
<span class="lineNum">      70 </span><span class="lineCov">      10000 :         TEST( _gotAsync );</span>
<span class="lineNum">      71 </span>            :         command.getNode()-&gt;send( CMD_DATA_REPLY )
<span class="lineNum">      72 </span><span class="lineCov">      10000 :             &lt;&lt; command.get&lt; uint32_t &gt;() &lt;&lt; ++_counter;</span>
<span class="lineNum">      73 </span><span class="lineCov">      10000 :         TEST( command.get&lt; std::string &gt;() == payload );</span>
<span class="lineNum">      74 </span><span class="lineCov">      10000 :         return true;</span>
<a name="75"><span class="lineNum">      75 </span>            :     }</a>
<span class="lineNum">      76 </span>            : 
<span class="lineNum">      77 </span><span class="lineCov">      10000 :     bool _cmdDataReply( co::ICommand&amp; command )</span>
<span class="lineNum">      78 </span>            :     {
<span class="lineNum">      79 </span><span class="lineCov">      10000 :         TEST( !_gotAsync );</span>
<span class="lineNum">      80 </span><span class="lineCov">      10000 :         const uint32_t request = command.get&lt; uint32_t &gt;();</span>
<span class="lineNum">      81 </span><span class="lineCov">      10000 :         const uint32_t result = command.get&lt; uint32_t &gt;();</span>
<span class="lineNum">      82 </span><span class="lineCov">      10000 :         TEST( result == ++_counter );</span>
<span class="lineNum">      83 </span><span class="lineCov">      10000 :         serveRequest( request, result );</span>
<span class="lineNum">      84 </span><span class="lineCov">      10000 :         return true;</span>
<span class="lineNum">      85 </span>            :     }
<span class="lineNum">      86 </span>            : };
<span class="lineNum">      87 </span>            : 
<span class="lineNum">      88 </span>            : typedef lunchbox::RefPtr&lt; LocalNode &gt; LocalNodePtr;
<span class="lineNum">      89 </span>            : 
<span class="lineNum">      90 </span>            : #ifndef _WIN32
<span class="lineNum">      91 </span>            : #  pragma clang diagnostic ignored &quot;-Wdeprecated-declarations&quot;
<span class="lineNum">      92 </span>            : #  pragma GCC diagnostic ignored &quot;-Wdeprecated-declarations&quot;
<a name="93"><span class="lineNum">      93 </span>            : #endif</a>
<span class="lineNum">      94 </span>            : 
<span class="lineNum">      95 </span><span class="lineCov">          1 : int main( int argc, char **argv )</span>
<span class="lineNum">      96 </span>            : {
<span class="lineNum">      97 </span><span class="lineCov">          1 :     TEST( co::init( argc, argv ) );</span>
<span class="lineNum">      98 </span>            : 
<span class="lineNum">      99 </span><span class="lineCov">          1 :     co::ConnectionDescriptionPtr connDesc = new co::ConnectionDescription;</span>
<span class="lineNum">     100 </span>            : 
<span class="lineNum">     101 </span><span class="lineCov">          1 :     connDesc-&gt;type = co::CONNECTIONTYPE_TCPIP;</span>
<span class="lineNum">     102 </span><span class="lineCov">          1 :     connDesc-&gt;setHostname( &quot;localhost&quot; );</span>
<span class="lineNum">     103 </span>            : 
<span class="lineNum">     104 </span><span class="lineCov">          2 :     LocalNodePtr server = new LocalNode;</span>
<span class="lineNum">     105 </span><span class="lineCov">          1 :     server-&gt;addConnectionDescription( connDesc );</span>
<span class="lineNum">     106 </span><span class="lineCov">          1 :     TEST( server-&gt;listen( ));</span>
<span class="lineNum">     107 </span>            : 
<span class="lineNum">     108 </span><span class="lineCov">          2 :     co::NodePtr serverProxy = new co::Node;</span>
<span class="lineNum">     109 </span><span class="lineCov">          1 :     serverProxy-&gt;addConnectionDescription( connDesc );</span>
<span class="lineNum">     110 </span>            : 
<span class="lineNum">     111 </span><span class="lineCov">          1 :     connDesc = new co::ConnectionDescription;</span>
<span class="lineNum">     112 </span><span class="lineCov">          1 :     connDesc-&gt;type = co::CONNECTIONTYPE_TCPIP;</span>
<span class="lineNum">     113 </span><span class="lineCov">          1 :     connDesc-&gt;setHostname( &quot;localhost&quot; );</span>
<span class="lineNum">     114 </span>            : 
<span class="lineNum">     115 </span><span class="lineCov">          2 :     LocalNodePtr client = new LocalNode;</span>
<span class="lineNum">     116 </span><span class="lineCov">          1 :     client-&gt;addConnectionDescription( connDesc );</span>
<span class="lineNum">     117 </span><span class="lineCov">          1 :     TEST( client-&gt;listen( ));</span>
<span class="lineNum">     118 </span><span class="lineCov">          1 :     TEST( client-&gt;connect( serverProxy ));</span>
<span class="lineNum">     119 </span>            : 
<span class="lineNum">     120 </span><span class="lineCov">          2 :     lunchbox::Clock clock;</span>
<span class="lineNum">     121 </span><span class="lineCov">      10001 :     for( size_t i = 0; i &lt; NCOMMANDS; ++i )</span>
<span class="lineNum">     122 </span><span class="lineCov">      10000 :         serverProxy-&gt;send( CMD_ASYNC );</span>
<span class="lineNum">     123 </span><span class="lineCov">          1 :     uint32_t request = client-&gt;registerRequest();</span>
<span class="lineNum">     124 </span><span class="lineCov">          1 :     serverProxy-&gt;send( CMD_SYNC ) &lt;&lt; request;</span>
<span class="lineNum">     125 </span><span class="lineCov">          1 :     client-&gt;waitRequest( request );</span>
<span class="lineNum">     126 </span><span class="lineCov">          1 :     const float asyncTime = clock.resetTimef();</span>
<span class="lineNum">     127 </span>            : 
<span class="lineNum">     128 </span><span class="lineCov">      10001 :     for( size_t i = 0; i &lt; NCOMMANDS; ++i )</span>
<span class="lineNum">     129 </span>            :     {
<span class="lineNum">     130 </span><span class="lineCov">      10000 :         request = client-&gt;registerRequest();</span>
<span class="lineNum">     131 </span><span class="lineCov">      10000 :         serverProxy-&gt;send( CMD_SYNC ) &lt;&lt; request;</span>
<span class="lineNum">     132 </span><span class="lineCov">      10000 :         client-&gt;waitRequest( request );</span>
<span class="lineNum">     133 </span>            :     }
<span class="lineNum">     134 </span><span class="lineCov">          1 :     const float syncTime = clock.resetTimef();</span>
<span class="lineNum">     135 </span>            : 
<span class="lineNum">     136 </span><span class="lineCov">      10001 :     for( size_t i = 0; i &lt; NCOMMANDS; ++i )</span>
<span class="lineNum">     137 </span>            :     {
<span class="lineNum">     138 </span><span class="lineCov">      10000 :         lunchbox::Request&lt; void &gt; future = client-&gt;registerRequest&lt; void &gt;();</span>
<span class="lineNum">     139 </span><span class="lineCov">      10000 :         serverProxy-&gt;send( CMD_SYNC ) &lt;&lt; future;</span>
<span class="lineNum">     140 </span><span class="lineCov">      10000 :     }</span>
<span class="lineNum">     141 </span><span class="lineCov">          1 :     const float syncTimeFuture = clock.resetTimef();</span>
<span class="lineNum">     142 </span>            : 
<span class="lineNum">     143 </span><span class="lineCov">      10001 :     for( size_t i = 0; i &lt; NCOMMANDS; ++i )</span>
<span class="lineNum">     144 </span>            :     {
<span class="lineNum">     145 </span>            :         lunchbox::Request&lt; uint32_t &gt; future =
<span class="lineNum">     146 </span><span class="lineCov">      10000 :             client-&gt;registerRequest&lt; uint32_t &gt;();</span>
<span class="lineNum">     147 </span><span class="lineCov">      10000 :         serverProxy-&gt;send( CMD_DATA ) &lt;&lt; future &lt;&lt; payload;</span>
<span class="lineNum">     148 </span><span class="lineCov">      10000 :     }</span>
<span class="lineNum">     149 </span><span class="lineCov">          1 :     const float syncTimePayload = clock.resetTimef();</span>
<span class="lineNum">     150 </span>            : 
<span class="lineNum">     151 </span><span class="lineCov">          1 :     std::cout &lt;&lt; &quot;Async command: &quot; &lt;&lt; asyncTime/float(NCOMMANDS)</span>
<span class="lineNum">     152 </span><span class="lineCov">          2 :               &lt;&lt; &quot; ms, sync: &quot; &lt;&lt; syncTime/float(NCOMMANDS)</span>
<span class="lineNum">     153 </span><span class="lineCov">          2 :               &lt;&lt; &quot; ms, using future: &quot; &lt;&lt; syncTimeFuture/float(NCOMMANDS+1)</span>
<span class="lineNum">     154 </span><span class="lineCov">          2 :               &lt;&lt; &quot; ms, with &quot; &lt;&lt; payload.size() &lt;&lt; &quot;b payload: &quot;</span>
<span class="lineNum">     155 </span><span class="lineCov">          2 :               &lt;&lt; syncTimePayload/float(NCOMMANDS+1) &lt;&lt; std::endl;</span>
<span class="lineNum">     156 </span>            : 
<span class="lineNum">     157 </span><span class="lineCov">          1 :     TEST( client-&gt;disconnect( serverProxy ));</span>
<span class="lineNum">     158 </span><span class="lineCov">          1 :     TEST( client-&gt;close( ));</span>
<span class="lineNum">     159 </span><span class="lineCov">          1 :     TEST( server-&gt;close( ));</span>
<span class="lineNum">     160 </span>            : 
<span class="lineNum">     161 </span><span class="lineCov">          1 :     serverProxy-&gt;printHolders( std::cerr );</span>
<span class="lineNum">     162 </span><span class="lineCov">          1 :     TESTINFO( serverProxy-&gt;getRefCount() == 1, serverProxy-&gt;getRefCount( ));</span>
<span class="lineNum">     163 </span><span class="lineCov">          1 :     TESTINFO( client-&gt;getRefCount() == 1, client-&gt;getRefCount( ));</span>
<span class="lineNum">     164 </span><span class="lineCov">          1 :     TESTINFO( server-&gt;getRefCount() == 1, server-&gt;getRefCount( ));</span>
<span class="lineNum">     165 </span>            : 
<span class="lineNum">     166 </span><span class="lineCov">          1 :     serverProxy = 0;</span>
<span class="lineNum">     167 </span><span class="lineCov">          1 :     client      = 0;</span>
<span class="lineNum">     168 </span><span class="lineCov">          1 :     server      = 0;</span>
<span class="lineNum">     169 </span>            : 
<span class="lineNum">     170 </span><span class="lineCov">          1 :     TEST( co::exit( ));</span>
<a name="171"><span class="lineNum">     171 </span>            : </a>
<span class="lineNum">     172 </span><span class="lineCov">          2 :     return EXIT_SUCCESS;</span>
<span class="lineNum">     173 </span><span class="lineCov">          3 : }</span>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.11</a></td></tr>
  </table>
  <br>

</body>
</html>
